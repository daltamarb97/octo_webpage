<div *ngIf="!companyInfo.forms">
    <h1>Tu empresa no tiene formularios activos en este momento</h1>
    <h3>Contáctanos a <a href="https://weareocto.web.app/front/pages/contact.html" target="_blank" style="color: #EF78A0">octo.colombia@gmail.com</a> para cear tu primer formulario</h3>
</div>
<div fxLayout="row wrap" *ngIf="companyInfo.forms">
    <div fxFlex.gt-sm="100" fxFlex.gt-xs="100" fxFlex="100">
        <mat-card>
        <mat-card-content>
            <div class="header-drop">
                <div class="header-drop-sub">
                    <mat-card-title *ngIf="currentForm">Resumen de información de: {{currentForm.alias | titlecase}}</mat-card-title>
                    <mat-card-subtitle *ngIf="showTable && currentForm && !currentForm.foreign">Para abrir Octo Form Builder, 
                        <span style="color: #E83D5E" (click)="showTable = false">haz click aqui</span> 
                    </mat-card-subtitle>
                    <mat-card-subtitle *ngIf="!showTable && currentForm && !currentForm.foreign">Para ver tabla de resultados, 
                        <span style="color: #E83D5E" (click)="showTable = true">haz click aqui</span> 
                    </mat-card-subtitle>
                </div>
                <mat-form-field appearance="fill">
                    <mat-label>Seleciona un formulario</mat-label>
                    <mat-select>
                        <mat-option *ngFor="let form of forms" (click)="changeForm(form)">{{form.alias}}</mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="search-field" *ngIf="currentForm">
                <mat-form-field color="accent" appearance="fill" class="date-form">
                    <mat-label>¿Desde qué fecha quieres ver los resultados?</mat-label>
                    <input 
                        matInput 
                        [matDatepicker]="picker1" 
                        [(ngModel)]="datePick" 
                        (focus)="picker1.open()" 
                        readonly>
                    <mat-datepicker #picker1></mat-datepicker>
                </mat-form-field>
                <button mat-stroked-button color="primary" (click)="searchFields()">Confirmar</button>
                <button id="download-button" mat-stroked-button color="primary" *ngIf="dataSource.length >= 1" (click)="downloadData()">Descargar datos en Excel</button>
            </div>
            <div class="responsive-table" *ngIf="showTable && !showCardsVersion">
                <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="mat-elevation-z8">
                    <ng-container matColumnDef="numero">
                        <th mat-header-cell *matHeaderCellDef> Número </th>
                        <td mat-cell *matCellDef="let element"> {{element.number || element.telefono}} </td>
                        </ng-container>
                    
                        <ng-container matColumnDef="acciones">
                        <th mat-header-cell *matHeaderCellDef> Acciones </th>
                        <td mat-cell *matCellDef="let element"> 
                            <button mat-stroked-button (click)="openTicket(element)">Abrir Ticket</button>
                        </td>
                    </ng-container>
                      <!-- expandable -->
                    <ng-container matColumnDef="expandedDetail">
                        <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplay.length">
                        <div class="example-element-detail"
                            [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
                            <mat-list role="list">
                                <mat-list-item class="element-detail__text" role="listitem" *ngFor="let j of expandedDataNames">{{j}}</mat-list-item>                               
                            </mat-list>
                            <mat-list role="list">
                                <mat-list-item role="listitem" *ngFor="let i of expandedData">{{i}}</mat-list-item>                               
                            </mat-list>
                        </div>
                        </td>
                    </ng-container>
                    <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
                    <tr mat-row *matRowDef="let element; columns: columnsToDisplay;" 
                        class="example-element-row"
                        [class.example-expanded-row]="expandedElement === element"
                        (click)="expandedElement = expandedElement === element ? null : element"
                        (click) ="getRowData(element)"
                        ></tr>
                    <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
                </table>
            </div>
            <!-- just for Porthos, for now -->
            <div fxLayout="row wrap" class="course-app" *ngIf="showTable && showCardsVersion">
                <div fxFlex.gt-md="33.33" fxFlex.gt-lg="33.33" fxFlex="100" *ngFor='let d of dataSource'>
                    <mat-card>
                    <mat-card-header class="response-header d-{{d.calificacion}}">
                        <mat-card-title>
                            <span class="response-date">
                                <mat-icon class="m-r-10">access_time</mat-icon>
                                {{d.fecha.split('-')[2] | slice:0:2}}-{{d.fecha.split('-')[1] | slice:0:2}}-{{d.fecha.split('-')[0] | slice:0:4}}
                            </span>
                            <span id="response-point">{{d.punto}}</span>
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content class="text-center">
                        <p class="m-b-5 title-bold">Calificación:  {{d.calificacion}}</p>
                        <small>{{d.comentarios}}</small>
                        <!-- see more details -->
                        <mat-expansion-panel>
                            <mat-expansion-panel-header>
                                <mat-panel-title>Ver más detalles</mat-panel-title>
                            </mat-expansion-panel-header>
                            <p><span class="bold-subtitle">Nombre: </span>{{d.nombre}} {{d.apellido}}</p>
                            <p><span class="bold-subtitle">Email: </span>{{d.email}}</p>
                            <p><span class="bold-subtitle">Telefono: </span>{{d.telefono}}</p>
                            <p><span class="bold-subtitle">Fecha de Nacimiento: </span>{{d.fecha_nacimiento | slice:0:10}}</p>
                            <p><span class="bold-subtitle">Hora: </span>{{d.hora}}</p>
                            <p><span class="bold-subtitle">Mesero: </span>{{d.mesero}}</p>
                        </mat-expansion-panel>
                    </mat-card-content>
                    <mat-card-actions class="text-center">
                        <button mat-button (click)="openTicket(d)">Abrir Ticket</button>
                    </mat-card-actions>
                    </mat-card>
                </div>
            </div>
            <!-- form builder -->
            <div class="bubble" *ngIf="!showTable">
                <mat-vertical-stepper [linear]="isLinear" #stepper>
                    <mat-step *ngFor="let message of formFlow">
                        <ng-template matStepLabel>{{(message.alias) ? message.alias : 'Final' }}</ng-template>
                        <div *ngIf="!edition">
                            <p><span style="font-weight: bold">Mensaje: </span>{{message.message}}</p>
                            <p *ngIf="!message.end"><span style="font-weight: bold">Tipo de respuesta: </span>{{(message.responseType === 'number') ? 'Número' : 'Palabra/frase'}}</p>
                        </div>
                        <div *ngIf="edition">
                            <mat-form-field class="example-full-width">
                                <mat-label>Mensaje</mat-label>
                                <input matInput placeholder="Escribe el mensaje aqui..." [(ngModel)]="messageEdition">
                            </mat-form-field>
                            <mat-form-field class="example-full-width" *ngIf="!message.end">
                                <mat-label>Tipo de respuesta</mat-label>
                                <select matNativeControl [(ngModel)]="typeMessageEdition">
                                    <option value="number">Número</option>
                                    <option value="string">Palabra/Frase</option>
                                </select>
                            </mat-form-field>
                            <p *ngIf="missingEditInfo" style="color: red;">Falta información en los campos</p>
                            <div class="edit-buttons">
                                <button mat-stroked-button color="primary" (click)="confirmMessageChanges(message)">Confirmar</button>
                                <button mat-stroked-button (click)="cancelChanges()">Cancelar</button>
                            </div>
                        </div>
                        <button mat-mini-fab style="background-color: #E83D5E" aria-label="Edit message" *ngIf="!message.main && !edition" (click)="edition = !edition">
                            <mat-icon>create</mat-icon>
                        </button>
                    </mat-step>
                </mat-vertical-stepper>
            </div>
        </mat-card-content>
        </mat-card>
    </div>
    </div>